# Cross-Platform Open Enclave SDK NuGet Package

This directory contains the scripts used to build a cross-platform NuGet package
for the Open Enclave SDK. The resulting package may be used on Windows to build
SGX enclaves as well as on Linux to build SGX and OP-TEE enclaves for the Scalys
Grapeboard (LS-1012A) and QEMU ARMv8.

The SGX builds are suitable both for SGX1 systems as well as for systems that
support FLC. All SGX builds contain enclave libraries with and without LVI
mitigations.

Note: The need for this guide is temporary until the current official NuGet
package is replaced either by the package as generated by this guide or by a
version thereof. Consult issue
[#3631](https://github.com/openenclave/openenclave/issues/3631) for additional
details.

## Environment Setup

Two build systems are required: the first must run Windows Server 2019 with GUI
and the second must run Ubuntu 18.04 LTS or later (Desktop and Server are both
OK). These two environments may exist on physical systems or in virtual
machines, it does not matter.

This section explains how to set up both environments.

### Windows Server 2019

1. Install Windows Server 2019 with GUI.
2. Download the SDK's [Windows prerequisites installation
   script](https://github.com/openenclave/openenclave/blob/master/scripts/install-windows-prereqs.ps1).
3. Execute the script as follows:
   ```powershell
   Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process
   .\install-windows-prereqs.ps1 -InstallPath C:/oe_prereqs -LaunchConfiguration SGX1FLC-NoIntelDrivers -DCAPClientType None
   ```
4. When prompted, reboot the system.

### Ubuntu

1. Run `setup-host.sh`, accepting the LXD initialization defaults.
2. Log out and log back in.
3. Run `setup-containers.sh` to create and start the containers used for
   building; unlike Docker containers, these remain running in the background
   and have persistent storage; think of them as virtual machines instead of
   containers.
4. Clone the SDK:
   ```bash
   git clone -b <latest release tag, eg. 'v0.12.x'> --recursive --depth=1 https://github.com/openenclave/openenclave sdk
   ```
5. Open `scripts/ansible/oe-contributors-setup.yml` and comment out the step
   that installs the Intel SGX driver because drivers cannot be installed inside
   containers, like so:
   ```yaml
   # - import_role:
   #     name: linux/intel
   #     tasks_from: sgx-driver.yml
   ```
6. Install the prerequisites in each container:
   ```bash
   # Enter the Xenial container.
   lxc exec oepkgxenial su ubuntu

   cd /host/path/to/sdk
   sudo scripts/ansible/install-ansible.sh
   ansible-playbook scripts/ansible/oe-contributors-setup-cross-arm.yml

   sudo apt install python3-pip p7zip-full -y
   pip3 install pycryptodome

   # Quit the Xenial container.
   exit


   # Enter the Bionic container.
   lxc exec oepkgbionic su ubuntu

   cd /host/path/to/sdk
   sudo scripts/ansible/install-ansible.sh
   ansible-playbook scripts/ansible/oe-contributors-setup-cross-arm.yml
   sudo apt install python3-pyelftools p7zip-full -y

   # Quit the Bionic container.
   exit
   ```

## Building

### SDK Version

The version of the NuGet package generated by this guide must match the version
of the SDK that it is produced for. To modify the version of the SDK being
packaged as well as the version of the NuGet package itself:

1. Change the name of the output NuGet package in all the instructions that
   follow;
2. Change the `OE_CROSS_PLATFORM_VERSION` in `devex/cross-nuget/extras/open-enclave.nuspec` - refer to the [NuGet page](https://www.nuget.org/packages/open-enclave-cross/) for the current version;
3. Change `OE_SDK_TAG` in `devex/cross-nuget/linux/driver.sh` or run with the `--oe_sdk_tag <sdk tag>` argument during the build phase of the [Ubuntu section](#Ubuntu);
4. Change `OE_SDK_TAG` in `devex/cross-nuget/windows/build.ps1` or run with the `-OE_SDK_TAG <sdk tag>` argument during the build phase of the [Windows section](#Windows).

### Windows

To build the SDK in all its configurations:

1. Launch the x64 Native Tools Command Prompt for VS 2017 from the Start menu.
2. Run:
   ```cmd
   cd %SYSTEMDRIVE%\path\to\this\repository\windows
   powershell -c "Set-ExecutionPolicy Bypass -Scope Process; .\build.ps1"
   powershell -c "Set-ExecutionPolicy Bypass -Scope Process; .\pack.ps1"
   ```

This creates a `Pack` directory with the build outputs.

### Ubuntu
To build the SDK in all its configurations, run:

```bash
cd /path/to/this/repository/linux
./driver.sh
./pack.sh
```

This creates a `pack` directory with the build outputs.

## Packaging

Fetch the resulting `pack` directories from both environments and merge their
contents. This can be achieved by copying the contents of one folder into the
other; there are no files that overlap.

Then, copy the contents of the `devex/vsextension/msbuild/` directory into the
`pack/build/native` directory. Additionally, copy the contents of the
`devex/cross-nuget/extras` directory into the `pack` directory. Update the
version information insde `open-enclave-cross.nuspec` if necessary.

Lastly, create a `licenses` directory inside the merged `pack` directory and
copy into it the following two files from the SDK:

1. `LICENSE`
2. `THIRD_PARTY_NOTICES`

To create the NuGet package, navigate to the root of the merged `pack` directory
and run:

```bash
# The extension informs 7z as to the type of archive to create.
# Update -mmt=## to the number of logical cores on your system.
7z a -mm=Deflate -mx=9 -mmt=8 -mfb=258 -mpass=15 -r out.zip .

# Update the file name if building a different version of the SDK.
mv out.zip open-enclave-cross.0.11.0.nupkg
```

Using 7-Zip in this manner instead of the official `nuget` tool is necessary to
ensure that the resulting `.nupkg` is below the maximum allowed file size in
`nuget.org` (and to not make users download a file five times the size), seeing
as the official NuGet tool uses a lower compression ratio and is not
configurable.
